#!/usr/bin/env bash
# Usage: script/package <os> <arch> <version>
#
# Packages the project as a release asset and prints the archive's filename.
set -e

os="${1?}"
arch="${2?}"
version="${3?}"

release="hub-${os}-${arch}-${version}"

case "$os" in
  darwin | freebsd | linux | netbsd | openbsd | solaris | windows ) ;;
  * ) echo "unsupported OS: $os" >&2; exit 1 ;;
esac

case "$arch" in
  386 | amd64 ) ;;
  * ) echo "unsupported arch: $arch" >&2; exit 1 ;;
esac

export GOOS="$os"
export GOARCH="$arch"

tmpdir="tmp/${release}"
rm -rf "$tmpdir"

exename="${tmpdir}/bin/hub"
[ "$os" != "windows" ] || exename="${exename}.exe"
mkdir -p "${exename%/*}"
script/build -o "$exename"

if [ "$os" = "windows" ]; then
  cp README.md "${tmpdir}/README.txt"
  cp LICENSE "${tmpdir}/LICENSE.txt"
  cp man/hub.1.html "${tmpdir}/hub.html"
else
  cp -R README.md LICENSE etc "$tmpdir"
  mkdir -p "${tmpdir}/share/man/man1"
  cp man/hub.1 "${tmpdir}/share/man/man1"
fi

pushd "${tmpdir%/*}" >/dev/null

if [ "$os" = "windows" ]; then
  file="${release}.zip"
  zip -r "$file" "$release" >/dev/null
else
  file="${release}.tgz"
  tar -czf "$file" "$release"
fi

echo "${PWD}/${file}"
